<style>
  .col-search {
    padding-left: 3px;
    padding-right: 3px;
  }
  /*    table.dataTable thead .sorting:after,
        table.dataTable thead .sorting:before,
        table.dataTable thead .sorting_asc:after,
        table.dataTable thead .sorting_asc:before,
        table.dataTable thead .sorting_asc_disabled:after,
        table.dataTable thead .sorting_asc_disabled:before,
        table.dataTable thead .sorting_desc:after,
        table.dataTable thead .sorting_desc:before,
        table.dataTable thead .sorting_desc_disabled:after,
        table.dataTable thead .sorting_desc_disabled:before {
            bottom: .5em;
        }*/
  .table thead th {
    text-align: center;
  }

  .col-flt-page {
    padding-top: 10px;
    font-weight: bold;
  }

  #tblReport tbody tr td a {
    cursor: pointer;
  }
  table.dataTable.fixedHeader-floating,
  table.dataTable.fixedHeader-locked {
    background-color: white;
    margin-top: 50px !important;
    margin-bottom: 0 !important;
  }
  @media print {
    table th:nth-child(0) {
      width: 200px;
      word-break: break-all;
      white-space: pre-line;
    }
    table td:nth-child(0) {
      width: 200px;
      word-break: break-all;
      white-space: pre-line;
    }
  }
  .text-header {
    font-weight: bold;
    font-size: 20px;
  }
  .text-wrap {
    white-space: normal;
  }
  .width-200 {
    width: 200px;
  }
  input[type="checkbox"] {
    margin-left: 5px;
    margin-right: 5px;
  } /*
    .cb_lb{
        margin-top:-5px;
    }*/
  .item-center {
    display: flex;
    justify-content: center;
  }
</style>
<div class="row">
  <h4 class="text-header text-center">QC Lab Tag Detail</h4>
</div>
<div class="row item-center">
  <div class="col-lg-3 col-md-3 col-sm-6 col-xs-6">
    <div class="input-group">
      <div class="input-group-addon">Tag ID</div>
      <input type="text" class="form-control" id="txtTagID" onkeyup="onEnterSearch()" />
    </div>
  </div>
  <div class="col-lg-3 col-md-3 col-sm-6 col-xs-6">
    <div class="input-group">
      <div class="input-group-addon">STS No</div>
      <input type="text" class="form-control" id="txtSTSNo" />
    </div>
  </div>
  <div class="col-lg-3 col-md-3 col-sm-6 col-xs-6">
    <div class="input-group">
      <div class="input-group-addon">Start Date</div>
      <input
        type="text"
        class="form-control"
        id="txtStartDate"
        autocomplete="off"
      />
    </div>
  </div>
  <div class="col-lg-3 col-md-3 col-sm-6 col-xs-6">
    <div class="input-group">
      <div class="input-group-addon">End Date</div>
      <input
        type="text"
        class="form-control"
        id="txtEndDate"
        autocomplete="off"
      />
    </div>
  </div>
  <div class="col-lg-1 col-md-1 col-sm-6 col-xs-6 text-left">
    <button class="btn btn-info" id="btnSearch">
      <i class="fa fa-search"></i>&nbsp; Search
    </button>
  </div>
  <div class="col-lg-1 col-md-1 col-sm-6 col-xs-6 text-left">
    <button class="btn btn-danger" id="btnRemove">
      <i class="fa fa-trash"></i>&nbsp; Clear Data
    </button>
  </div>
</div>

<div class="row" id="rowResultTable">
  <table
    class="table table-condensed table-bordered table-striped"
    width="100%"
    id="tblReport"
  >
    <thead>
      <tr>
        <!--<th >#</th>-->
        <th class="bg-gray">หมายเลขปฏิบัติการ</th>
        <th class="bg-gray">Remove</th>
        <th class="bg-gray">Item</th>
        <th class="bg-gray">Lot</th>
        <th class="bg-gray">Tag ID</th>
        <th class="bg-gray">Size</th>
        <th class="bg-gray">Schedule</th>
        <th class="bg-gray">Length</th>
        <th class="bg-gray">Standard</th>
        <th class="bg-gray">Grade</th>
        <th class="bg-gray">STS No</th>
        <th class="bg-gray">Coil No</th>
        <th class="bg-gray">Heat No</th>
        <th class="bg-gray">FM</th>
        <th class="bg-gray">หนา x กว้าง</th>
        <th class="bg-gray">ชั้นคุณภาพ</th>
        <th class="bg-gray">Date</th>
        <th class="bg-gray">sts_C</th>
        <th class="bg-gray">sts_Si</th>
        <th class="bg-gray">sts_Mn</th>
        <th class="bg-gray">sts_P</th>
        <th class="bg-gray">sts_S</th>
        <th class="bg-gray">sts_Cu</th>
        <th class="bg-gray">sts_V</th>
        <th class="bg-gray">sts_Ni</th>
        <th class="bg-gray">sts_Cr</th>
        <th class="bg-gray">sts_Mo</th>
        <th class="bg-gray">sts_Ti</th>
        <th class="bg-gray">sts_Nb</th>
        <th class="bg-gray">sts_Al</th>
        <th class="bg-gray">sts_B</th>
        <th class="bg-gray">sts_Co</th>
        <th class="bg-gray">sts_Pb</th>
        <th class="bg-gray">sts_Fe</th>
        <th class="bg-gray">sts_Ts</th>
        <th class="bg-gray">sts_Ys</th>
        <th class="bg-gray">sts_El</th>
      </tr>
    </thead>
    <!--        <tbody id="tblReportList">
                    <tr><td align="center" colspan="12">.... No item search ....</td></tr>
                </tbody>-->

  </table>
</div>
<script type="text/javascript">

   let mydata = [];

  $("#btnSearch").click(function () {
    ReportItemSearch();
  });

  function onEnterSearch(e) {
    if ($('#txtTagID').val() == '') {
            return false;
        }
		var keycode;
		if (window.event) keycode = window.event.keyCode; //  IE
		else if (e) keycode = e.which; //  Firefox 		
		if (keycode == 13) {
      ReportItemSearch();
  }
}


  $("#txtStartDate,#txtEndDate").datepicker({
    dateFormat: "yy-mm-dd",
  });

  function removeById(id) {
    // remove item by id and update table data
    let table = $("#tblReport").DataTable();
    mydata = mydata.filter((item) => item.id != id);
    table.clear()
    table.rows.add(mydata)
    table.draw()
  }
  
  $("#btnRemove").click(function () {
    mydata = [];
    $("#tblReport").DataTable().clear().destroy();
  });

  function ReportItemSearch() {
    var OldHtml = $("#btnSearch").html();
    let TagID = $("#txtTagID").val();
    let STSNo = $("#txtSTSNo").val();
    var StartDate = $("#txtStartDate").val();
    var EndDate = $("#txtEndDate").val();

    if (StartDate != "" && EndDate == "" || StartDate == "" && EndDate != "") {
        $.alert("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุดให้ครบถ้วน");
        return false;
    }

    if (TagID == "" && STSNo == "" && StartDate == "" && EndDate == "") {
      $.alert("กรุณากรอกข้อมูลอย่างน้อย 1 ช่อง");
      return false;
    } else {
      $("#btnSearch").html("<i class='fa fa-spinner fa-spin'></i>");
      $("#tblReport").loading();
      $("#tblReport tfoot").remove();
      $.ajax({
        type: "POST",
        url: "././module/RPT_QC_Lab_Tag_Detail/data.php",
        dataType: "json",
        beforeSend: function () {
          $("#btnSearch").html("<i class='fa fa-spinner fa-spin'>");
        },
        data: {
          load: "ajax",
          tag_id: TagID,
          sts_no: STSNo,
          StartDate: StartDate,
          EndDate: EndDate,
        },
        success: function (data) {
          // update mydata + old data 
          //console.log(data);
          mydata.push(...data);
          // but not duplicate
          // mydata = [...mydata, ...data.filter((item) => !mydata.some((old) => old.id == item.id))];

          $("#tblReport").DataTable().clear();
          $("#tblReport").append(
            "<tfoot><tr></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></td></tr></tfoot>"
          );
          $("#tblReport").dataTable({
            aaData: mydata,
            paging: false,
            fixedHeader: true,
            destroy: true,
            processing: true,
            scrollY: "65vh",
            scrollCollapse: true,
            scrollX: true,
            columns: [
              {
                data: "qc_oper_num",
                className: "text-center",
                render: function (data, type, row, meta) {
                  let qc_oper_num = data == null ? "" : data;
                  let ret = `<span hidden>${qc_oper_num}</span><input type='text' class='input-text-value' size='20' id=${row.id} onchange="SaveQc(this.id,value);" value='${qc_oper_num}' />`;
                  return ret;
                },
              },
              {
                data: "id",
                className: "text-center",
                render: function (data) {
                   return '<button onclick="removeById('+data+')" class="btn btn-danger">ลบ</button>'
                }
              },
              {
                data: "item",
                className: "text-center",
              },
              {
                data: "lot",
                className: "text-center",
              },
              {
                data: "id",
                className: "text-center",
              },
              {
                data: "size",
                className: "text-center",
              },
              {
                data: "uf_schedule",
                className: "text-center",
              },
              {
                data: "uf_length",
                className: "text-center",
              },
              {
                data: "standard",
                className: "text-center",
              },
              {
                data: "uf_grade",
                className: "text-center",
              },
              {
                data: "sts_no",
                className: "text-center",
              },
              {
                data: "Coil_No",
                className: "text-center",
              },
              {
                data: "Heat_no",
                className: "text-center",
              },
              {
                data: "FM",
                className: "text-center",
              },
              {
                data: "thick",
                className: "text-center",
              },
              {
                data: "grade",
                className: "text-center",
              },
              {
                data: "date.date",
                className: "text-center",
                render: function (data, type, row) {
                  return data.split(" ")[0];
                },
              },
              {
                data: "sts_c",
                className: "text-center",
              },
              {
                data: "sts_si",
                className: "text-center",
              },
              {
                data: "sts_mn",
                className: "text-center",
              },
              {
                data: "sts_p",
                className: "text-center",
              },
              {
                data: "sts_s",
                className: "text-center",
              },
              {
                data: "sts_cu",
                className: "text-center",
              },
              {
                data: "sts_v",
                className: "text-center",
              },
              {
                data: "sts_ni",
                className: "text-center",
              },
              {
                data: "sts_cr",
                className: "text-center",
              },
              {
                data: "sts_mo",
                className: "text-center",
              },
              {
                data: "sts_ti",
                className: "text-center",
              },
              {
                data: "sts_nb",
                className: "text-center",
              },
              {
                data: "sts_al",
                className: "text-center",
              },
              {
                data: "sts_b",
                className: "text-center",
              },
              {
                data: "sts_co",
                className: "text-center",
              },
              {
                data: "sts_pb",
                className: "text-center",
              },
              {
                data: "sts_fe",
                className: "text-center",
              },
              {
                data: "sts_ts",
                className: "text-center",
              },
              {
                data: "sts_ys",
                className: "text-center",
              },
              {
                data: "sts_el",
                className: "text-center",
              },
             
            ],
            dom:
              "<'row'<'col-md-5'B><'col-md-7 text-right col-flt-page'lf>>" +
              "<'row'<'col-md-12'tr>>" +
              "<'row'<'col-md-5 text-left'i><'col-sm-7 text-right'p>>",
            buttons: [
              {
                extend: "print",
                text: "<i class='fa fa-print'></i>&nbsp;Print",
                title: "",
              },
              {
                extend: "excel",
                footer: true,
                text: "<i class='fa fa-file-excel'></i>&nbsp;Excel",
                title:
                  "RPT_GENERAL_LEDGER_DOMESTIC_INVOICE_" +
                  StartDate +
                  "_to_" +
                  EndDate,
              },
            ]
          });

          $("#tblReport").loading("stop");
          $("#btnSearch").html(OldHtml);
        },
        error: function (e) {
          $("#tblReport").loading("stop");
          $("#btnSearch").html(OldHtml);
          console.log("There was an error with your request...");
          console.log("error: " + JSON.stringify(e));
        },
      });
    }
  }
  $("#btnExportExcel").click(function () {
    //        onclick="javascript:
    //       xport.toCSV('tblReport');
  });

  $("#StartDate,#EndDate").datepicker({
    dateFormat: "yy-mm-dd",
  });

  function SaveQc(qc_id,qc_value) {
    $.ajax({
      type: "POST",
      url: "././module/RPT_QC_Lab_Tag_Detail/data.php",
      dataType: "json",
      data: {
        load: "save",
        tag_id: qc_id,
        qc_oper_num: qc_value,
      },
      success: function (data) {
        console.log(data);
      },
      error: function (e) {
        console.log("There was an error with your request...");
        console.log("error: " + JSON.stringify(e));
      },
    });
    }
</script>

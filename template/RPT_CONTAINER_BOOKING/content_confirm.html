<style>
    .mycontainer2 {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        margin-left: auto;
        margin-right: auto;

    }

    .mybox {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        flex-grow: 1;
        gap: 1rem;
        margin-bottom: 1.25rem;
    }

     .custom-checkbox input[type="checkbox"] {
        display: none;
    }

    /* ตำแหน่งและขนาดของ Checkbox */
    .custom-checkbox {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        font-size: 14px;
        gap: 0rem;
        margin: 3px;
    }

    /* สไตล์สำหรับ Checkmark */
    .custom-checkbox .checkmark {
        width: 20px;
        height: 20px;
        background-color: #ccc;
        border-radius: 4px;
        display: inline-block;
        margin-right: 10px;
        position: relative;
        transition: background-color 0.3s;
    }

    /* สไตล์สำหรับ Checkbox เมื่อถูกเลือก */
    .custom-checkbox input[type="checkbox"]:checked+.checkmark {
        background-color: #4CAF50;
    }

    /* สไตล์สำหรับเครื่องหมายถูก */
    .custom-checkbox .checkmark::after {
        content: "";
        position: absolute;
        display: none;
    }

    /* แสดงเครื่องหมายถูกเมื่อ Checkbox ถูกเลือก */
    .custom-checkbox input[type="checkbox"]:checked+.checkmark::after {
        display: block;
    }

    /* รูปแบบของเครื่องหมายถูก */
    .custom-checkbox .checkmark::after {
        left: 8px;
        top: 3px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
    }
    
</style>
<h3 class="text-header text-left m-4">Container Manage</h3>
</div>
<div class="mycontainer2">
    <div class="row col-xs-12">
        <div class="mybox">
            <div class="input-group basis-1/6">
                <div style="color: red; font-weight: bold; font-size: 16px;" class="input-group-addon">City *</div>
                <select style="font-weight: bold; font-size: 16px;" class="form-control txt-filter" id="doc_num_manage">
                    <option value=""></option>
                </select>
            </div>
            <div class="input-group basis-1/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Co Num</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="co_num_search">
            </div>
            <div class="input-group basis-1/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Cust PO</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="cust_po">
            </div>
            <div class="input-group basis-1/6 hidden">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Cust Name</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="cust_name">
            </div>
            <div class="input-group basis-1/6 hidden">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">City</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="city_search">
            </div>
            <div class="input-group basis-1/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">STS PO</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="sts_po">
            </div>     
            <div class="input-group basis-1/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Size</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="cm_size">
            </div>  
            <div class="input-group basis-1/6">
                <div class="flex gap-1">
                    <label class="custom-checkbox">
                        <input type="checkbox" name='remain' />
                        <span class="checkmark"></span>
                         Remain
                    </label>
                    <label class="custom-checkbox">
                        <input type="checkbox" name='ready' />
                        <span class="checkmark"></span>
                         Ready
                    </label>
                    <button type="button" class="btn btn-primary" id="btnSearchManage">Search</button>
                </div>
            </div>
        </div>

        <!-- <hr />
        <div class="mybox">
            <div class="input-group basis-2/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon ">Doc Num</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter" id="doc_num_ref" readonly>
            </div>
             <div class="input-group basis-2/6">
                 <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Co Num</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter" id="co_num_ref" readonly>
            </div>
             <div class="input-group basis-2/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Co Line</div>
                 <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter" id="co_line" readonly>
            </div>
    
        </div>
         <div class="mybox">
             <div class="input-group basis-2/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">End Cust</div>
                 <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter" id="end_cust">
            </div>
             <div class="input-group basis-2/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">City</div>
                 <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter" id="city_manage">
            </div>
            <div class="input-group basis-2/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Container No.</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter" id="container_no">
            </div>
             <div class="input-group basis-2/6">
                 <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Bundle</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter" id="bundle">
            </div>
        </div>
        <div>
            <button type="button" class="btn btn-success btn-lg" id="btnAddContainerManage" disabled>Add Container</button>
            <button type="button" class="btn btn-info btn-lg" id="btnViewContainer" disabled>View Container</button>
        </div> -->

    </div>
</div>

<div class="row">
    <table width="100%" class="table table-condensed table-bordered table-striped" id="tblReportContainerManage">
        <thead>
            <tr>
                <th class="bg-gray">Doc</th>
                <th class="bg-gray">Job</th>
                <th class="bg-gray">STS PO</th>
                <th class="bg-gray">Cust</th>
                <th class="bg-gray">Size</th>
                <th class="bg-gray">Spec</th>
                <th class="bg-gray">Sch.</th>
                <th class="bg-gray">Length</th>
                <th class="bg-gray">Type</th>
                <th class="bg-gray">Pack</th>
                <th class="bg-gray">Co No.</th>
                <th class="bg-gray">Order</th>
                <th class="bg-gray">Remain</th>
                <th class="bg-gray">Loaded</th>
                <th class="bg-gray">Ready</th>
                <th class="bg-gray">Line</th>
                <th id="th1" class="bg-gray">1</th>
                <th class="bg-gray">2</th>
                <th class="bg-gray">3</th>
                <th class="bg-gray">4</th>
                <th class="bg-gray">5</th>
                <th class="bg-gray">6</th>
                <th class="bg-gray">7</th>
                <th class="bg-gray">8</th>
                <th class="bg-gray">9</th>
                <th class="bg-gray">10</th>
                <th class="bg-gray">11</th>
                <th class="bg-gray">12</th>
                <th class="bg-gray">13</th>
                <th class="bg-gray">14</th>
                <th class="bg-gray">15</th>
                <th class="bg-gray">16</th>
                <th class="bg-gray">17</th>
                <th class="bg-gray">18</th>
                <th class="bg-gray">19</th>
                <th class="bg-gray">20</th>
                <th class="bg-gray">21</th>
                <th class="bg-gray">22</th>
                <th class="bg-gray">23</th>
                <th class="bg-gray">24</th>
                <th class="bg-gray">25</th>
                <th class="bg-gray">26</th>
                <th class="bg-gray">27</th>
                <th class="bg-gray">28</th>
                <th class="bg-gray">29</th>
                <th class="bg-gray">30</th>
                <th class="bg-gray">Add</th>
                <th class="bg-gray">มัดเศษ</th>
            </tr>
        </thead>
        <!--        <tbody id="tblReportList">
                      <tr><td align="center" colspan="12">.... No item search ....</td></tr>
     </tbody>-->
    </table>
</div>
<!-- Modal -->
<div class="modal fade bd-example-modal-lg m-8" id="ModalContainer" role="dialog" aria-labelledby="myLargeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-center" id="exampleModalLabel">รายการส่งสินค้า</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <table style="width: 100%" class="table table-condensed table-bordered table-striped"
                        id="tblReportContainerLine">
                        <thead>
                            <tr>
                                <th class="bg-gray">Doc No</th>
                                <th class="bg-gray">Co Num</th>
                                <th class="bg-gray">Co Line</th>
                                <th class="bg-gray">End Cust</th>
                                <th class="bg-gray">City</th>
                                <th class="bg-gray">Container No.</th>
                                <th class="bg-gray">Bundle</th>
                                <th class="bg-gray">มัดเศษ</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

    // draggable
var summaryContainer = document.getElementById('summaryContainer');
var originalPosition = null;
var isVisible;
var maxWeight;

    getDocNumList();

    function getDocNumList() {
        $.ajax({
            type: "GET",
            url: "././module/RPT_CONTAINER_BOOKING/data.php",
            dataType: "json",
            data: {
                load: "GetDocList"
            },
            success: function (data) {
                let doc = [{ id: '', text: '' }].concat(data.map((item) => ({
                id: item.doc_num,
                text: item.doc_num
            })));
                $("#doc_num_manage").empty();
                $("#doc_num_manage").select2({
                    placeholder: 'กรุณาเลือก Doc Num',
                    allowClear: true,
                    width: '100%',
                    data: doc,
                    language: {
                        noResults: function () {
                            return "ไม่พบข้อมูล";
                        }
                    }
                });
            }
        });
    }

    $("#customer_booking").select2({
        placeholder: 'กรุณาเลือก Customer',
        allowClear: true,
        width: '100%',
        data: [],
        language: {
            noResults: function () {
                return "ไม่พบข้อมูล";
            }
        }
    });

    $("#co_num_booking").select2({
        placeholder: 'กรุณาเลือก Customer',
        allowClear: true,
        width: '100%',
        data: [],
        language: {
            noResults: function () {
                return "ไม่พบข้อมูล";
            }
        }
    });


    // add footer to table tblReportContainerManage
 
    var table = $('#tblReportContainerManage').DataTable({

        paging: false,
        searching: false,
        width: "100%",
        fixedHeader: true,
        scrollX: true,
        scrollY: "80vh",
        
        columnDefs: [
             { "targets": '_all', "className": 'text-center' },
            {
              targets: [3],
              width: 100
            },
            {
                targets: [5],
                width: 100
            }
        ],
        columns: [

            { "data": "doc_num" },
            { "data": "job" },
   
            { "data": "sts_po" },
            { "data": "cust_po" },
            { "data": "size" },
            { "data": "spec" },
            { "data": "schedule" },
            { "data": "length" },
            { "data": "type" },
            { "data": "pack" },
                     { "data": "co_num" },
                     { "data": "qty_bundle"},
                     { "data": "qty_remain"},
                     { "data": "qty_loaded"},
                     { "data": "qty_ready" },
            { "data": "co_line" },
            // on select container
        
             // loop column 1-30
            ...Array.from({ length: 30 }, (_, index) => ({
                "data": index + 1,
                visible: false,
                render: function (data, type, row, meta) {
                    // ดึงค่าจาก field ที่ต้องการตาม container_no
                    let fieldName = `${index + 1}`;
                    let val = row[fieldName] || '';

                    if (val == null || val == undefined) {
                        val = "";
                    }

                    return `<input size="5" type='text' class='form-control container-input' value='${val}' data-field='${fieldName}' data-row='${meta.row}' onchange="SaveContainer(this, ${meta.row},'bundle', ${index + 1});">`;
                }
            })),
            {
                "data": null,
                render: function (data, type, row, meta) {
                    return `<button class='btn btn-primary' onclick="addContainer(this, ${meta.row});">Add</button>`;
                }
            },
            {
                "data": null,
                render: function (data, type, row, meta) {
                    // ดึงค่าจาก field ที่ต้องการตาม container_no
                    let fieldName = `bundle_pcs`;
                    let val = row[fieldName] || '';
    

                    return `<input size="5" type='text' class='form-control container-input' value='${val}' data-field='${fieldName}' data-row='${meta.row}' onchange="SaveContainer(this, ${meta.row}, 'pcs');">`;
                }
            },
            
            

        ],
        dom:
            "<'row'<'col-md-5'B><'col-md-7 text-right col-flt-page'lf>>" +
            "<'row'<'col-md-12'tr>>" +
            "<'row'<'col-md-5 text-left'i><'col-sm-7 text-right'p>>",
        buttons: [
               // disable visible column 
               {
                  text: '<button class="btn btn-danger">Add Container</button>',
                  action: function (e, dt, node, config) {
                    // check visible column 16 - 30
                    table.columns(isVisible).visible(true);
                    isVisible++;
                  }
               },
               {
    text: "<i style='font-size: 16px; background-color: #333333; color: white; padding: 5px; border: 1px solid #333333; border-radius: 3px;' class='fa fa-columns'></i>&nbsp; ซ่อน / แสดง Column <span class='caret'></span>",
    action: function (e, dt, node, config) {
        var table = dt;
        
        // ตรวจสอบว่า dropdown มีอยู่แล้วหรือไม่
        if ($(node).find('.dropdown-menu').length > 0) {
            // ถ้ามีอยู่แล้วให้ toggle แทน
            $(node).find('.dropdown-menu').toggle();
            return;
        }
        
        // สร้าง dropdown menu สำหรับเลือก column ที่จะแสดง/ซ่อน
        var columns = table.columns().indexes();
        var columnNames = [];
        
        // เก็บชื่อ column ที่ต้องการแสดงใน dropdown
        columns.each(function(index) {
            var column = table.column(index);
            var header = column.header();
            
            if (header) {
                var columnName = $(header).text().trim();
                
                // ตรวจสอบว่ามีชื่อ column และไม่ใช่ช่องว่าง
                if (columnName && columnName !== '') {
                    columnNames.push({
                        index: index,
                        name: columnName,
                        visible: column.visible()
                    });
                }
            }
        });
        
        // ตรวจสอบว่ามี column ให้แสดงหรือไม่
        if (columnNames.length === 0) {
            alert('ไม่พบ column ที่สามารถซ่อน/แสดงได้');
            return;
        }
        
        // สร้าง HTML สำหรับ dropdown
        var dropdownHtml = '<div class="btn-group column-visibility-dropdown">' +
            '<button type="button" class="btn btn-default" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
            '<i class="fa fa-columns"></i>&nbsp; ซ่อน / แสดง Column <span class="caret"></span>' +
            '</button>' +
            '<ul class="dropdown-menu dropdown-menu-right" style="min-width: 200px;">';
        
        // เพิ่ม checkbox สำหรับแต่ละ column
        columnNames.forEach(function(col) {
            var checked = col.visible ? 'checked' : '';
            var iconClass = col.visible ? 'fa-eye' : 'fa-eye-slash';
            console.log(col);
            
            
            dropdownHtml += '<li>' +
                '<label class="column-checkbox-label" style="margin: 0; padding: 8px 15px; cursor: pointer; display: block; font-weight: normal; background-color: #333333;">' +
                '<input type="checkbox" ' + checked + ' style="margin-right: 8px;" ' +
                'data-column-index="' + col.index + '">' +
                '<i class="fa ' + iconClass + '" style="margin-right: 5px; width: 15px;"></i>' +
                col.name +
                '</label>' +
                '</li>';
        });
        
        dropdownHtml += '</ul></div>';
        
        // แทนที่ button เดิมด้วย dropdown
        $(node).html(dropdownHtml);
        
        // ป้องกันการปิด dropdown เมื่อคลิกข้างใน
        $(node).find('.dropdown-menu').on('click', function(e) {
            e.stopPropagation();
        });
        

        // เพิ่ม event listener สำหรับ checkbox
        $(node).find('input[type="checkbox"]').on('change', function() {
            var checkbox = $(this);
            var columnIndex = parseInt(checkbox.data('column-index'));
            var isVisible = checkbox.is(':checked');
            var label = checkbox.closest('label');
            var icon = label.find('i.fa');
            
            // เปลี่ยน visibility ของ column
            table.column(columnIndex).visible(isVisible);
            
            // เปลี่ยนไอคอน
            if (isVisible) {
                icon.removeClass('fa-eye-slash').addClass('fa-eye');
            } else {
                icon.removeClass('fa-eye').addClass('fa-eye-slash');
            }
            
            // เพิ่มเอฟเฟค visual feedback
            label.addClass('column-changing');
            setTimeout(function() {
                label.removeClass('column-changing');
            }, 200);
        });
        
    }
}
          /*  {
                text: `<select class="form-control" id="containerSelect" style="min-width: 150px; font-weight: bold; font-size: 16px;">
                   <option value="1">1</option>
                   <option value="2">2</option>
                   <option value="3">3</option>
                   <option value="4">4</option>
                   <option value="5">5</option>
                   <option value="6">6</option>
                   <option value="7">7</option>
                   <option value="8">8</option>
                   <option value="9">9</option>
                   <option value="10">10</option>
                   <option value="11">11</option>
                   <option value="12">12</option>
                   <option value="13">13</option>
                   <option value="14">14</option>
                   <option value="15">15</option>
                   <option value="16">16</option>
                   <option value="17">17</option>
                   <option value="18">18</option>
                   <option value="19">19</option>
                   <option value="20">20</option>
                   <option value="21">21</option>
                   <option value="22">22</option>
                   <option value="23">23</option>
                   <option value="24">24</option>
                   <option value="25">25</option>
                   <option value="26">26</option>
                   <option value="27">27</option>
                   <option value="28">28</option>
                   <option value="29">29</option>
                   <option value="30">30</option>
               </select>`,
                action: function (e, dt, node, config) {
                    // ป้องกัน default action
                    e.preventDefault();
                    e.stopPropagation();
                },
                init: function (api, node, config) {
                    // เพิ่ม event listener เมื่อเปลี่ยนค่า select
                    $(node).find('#containerSelect').on('change', function (e) {
                        e.stopPropagation(); // ป้องกัน bubble up
                        let selectedValue = $(this).val();
                        if (selectedValue) {
                            container_no = selectedValue;

                            // วิธีง่ายสุด - อัพเดต input โดยตรง
                            $('.container-input').each(function () {
                                let $input = $(this);
                                let row = table.row($input.closest('tr')).data();
                                let newValue = row[`${selectedValue}`] || '';
                                $input.val(newValue);
                            });

                            $.ajax({
                                type: "GET",
                                url: "././module/RPT_CONTAINER_CONFIRM/data.php",
                                dataType: "json",
                                data: {
                                    load: "GetTotalWeight",
                                    doc_num: $("#doc_num_manage").val()
                                },
                                success: function (data) {
                                    $("#total_weight").val(addCommas(data[container_no - 1].total_weight));
                                    $("#total_bundle").val(data[container_no - 1].total_bundle);
                                }
                            });

                            var doc_num = $("#doc_num_manage").val();
                            var co_num = $("#co_num_search").val();
                            var cust_po = $("#cust_po").val();
                            var cust_name = $("#cust_name").val();
                            var city = $("#city_search").val();
                            var sts_po = $("#sts_po").val();
                            var size = $("#cm_size").val();
                            // GetBookingLine new data
                            $.ajax({
                                type: "GET",
                                url: "././module/RPT_CONTAINER_CONFIRM/data.php",
                                dataType: "json",
                                data: {
                                    load: "GetBookingLine",
                                    doc_num: doc_num,
                                    co_num: co_num,
                                    cust_po: cust_po,
                                    cust_name: cust_name,
                                    city: city,
                                    sts_po: sts_po,
                                    size: size
                                },
                                success: function (data) {

                                    if (data.length == 0) {
                                        alert("ไม่พบข้อมูล");
                                        $("#btnAddContainerManage").attr("disabled", true);
                                        $("#btnViewContainer").attr("disabled", true);
                                        $("#doc_num_ref").val('');
                                        $("#co_num_ref").val('');
                                        $("#co_line").val('');
                                        $("#end_cust").val('');
                                        $("#end_city").val('');
                                        $("#container_no").val('');
                                        $("#bundle").val("");
                                        table.clear().draw();
                                        return false;
                                    }

                                    table.clear();

                                    table.rows.add(data).draw();
                                    $("#btnAddContainerManage").attr("disabled", true);
                                    $("#btnViewContainer").attr("disabled", true);
                                    $("#doc_num_ref").val('');
                                    $("#co_num_ref").val('');
                                    $("#co_line").val('');
                                    $("#end_cust").val('');
                                    $("#end_city").val('');
                                    $("#container_no").val('');
                                    $("#bundle").val("");

                                },

                                error: function (xhr, status, error) {
                                    alert('Error');
                                }
                            });



                        }
                    });

                    // ป้องกันไม่ให้คลิกที่ select ทำให้เกิดปัญหา
                    $(node).find('#containerSelect').on('click', function (e) {
                        e.stopPropagation();
                    });
                }
            } */
        ],
    });

    function addContainer(element, rowIndex) {
        // visible column 16 - 30
        table.columns(isVisible).visible(true);
        isVisible++;
    }


    $.ajax({
        type: "GET",
        url: "././module/RPT_CONTAINER_BOOKING/data.php",
        dataType: "json",
        data: { load: "GetCity" },
        success: function (data) {
            let city = [{ id: '', text: '' }].concat(data.map((item) => ({
                id: item.city,
                text: item.city
            })));

            $("#city_booking").select2({
                placeholder: 'กรุณาเลือก City',
                allowClear: true,
                width: '100%',
                data: city,
                language: {
                    noResults: function () {
                        return "ไม่พบข้อมูล";
                    }
                }
            }).on('select2:select', function (e) {
                let city = e.params.data.id;
                $.ajax({
                    type: "GET",
                    url: "././module/RPT_CONTAINER_BOOKING/data.php",
                    dataType: "json",
                    data: { load: "GetCustomerByCity", city: city },
                    success: function (data) {
                        const customer = [{ id: '', text: '' }].concat(data.map((item) => ({
                            id: item.name,
                            text: item.name
                        })));

                        $("#customer_booking").empty();
                        $("#customer_booking").select2({
                            placeholder: 'กรุณาเลือก Customer',
                            allowClear: true,
                            width: '100%',
                            data: customer,
                            language: {
                                noResults: function () {
                                    return "ไม่พบข้อมูล";
                                }
                            }
                        }).on('select2:select', function (e) {
                            let customer = e.params.data.id;
                            $.ajax({
                                type: "GET",
                                url: "././module/RPT_CONTAINER_BOOKING/data.php",
                                dataType: "json",
                                data: { load: "GetCoNum", city: city, customer: customer },
                                success: function (data) {
                                    let co_num = [{ id: '', text: '' }].concat(data.map((item) => ({
                                        id: item.co_num,
                                        text: item.co_num
                                    })));
                                    $("#co_num_booking").empty();
                                    $("#co_num_booking").select2({
                                        placeholder: 'กรุณาเลือก Co_num',
                                        allowClear: true,
                                        width: '100%',
                                        data: co_num,
                                        language: {
                                            noResults: function () {
                                                return "ไม่พบข้อมูล";
                                            }
                                        }
                                    });
                                },
                            });
                        });
                    },
                });
            });
        }
    });

    $("#btnGenarateDoc").click(function () {
        $.ajax({
            type: "GET",
            url: "././module/RPT_CONTAINER_BOOKING/data.php",
            dataType: "json",
            data: {
                load: "GenerateDoc"
            },
            success: function (data) {
                $("#doc_num_manage").val(data);
                $("#city_booking").val('').trigger('change');
                $("#customer_booking").val('').trigger('change');
                $("#co_num_booking").val('').trigger('change');
                $("#container_40").val('');
                $("#container_45").val('');
                $("#booking_number40").val('');
                $("#booking_number45").val('');
                $("#booking_date").val('');
                $("#status_booking").val('ดำเนินการ');
                $("#btnAddContainerManage").attr("disabled", false);
                $("#btnUpdateBooking").attr("disabled", true);
                $("#old_co_num").val("");
                table.clear().draw();
            },
            error: function (xhr, status, error) {
                alert('Error');
            }
        });
    });

    $("#btnSearchManage").click(function () {
        var doc_num = $("#doc_num_manage").val();
        var co_num = $("#co_num_search").val();
        var cust_po = $("#cust_po").val();
        var cust_name = $("#cust_name").val();
        var city = $("#city_search").val();
        var sts_po = $("#sts_po").val();
        var size = $("#cm_size").val();
        var remain = $("input[name='remain']:checked").val();
        var ready = $("input[name='ready']:checked").val();

        if (doc_num == "" && co_num == "" && cust_po == "" && cust_name == "" && city == "" && sts_po == "") {
            alert("กรุณากรอกข้อมูลในการค้นหา");
            return false;
        }

        $.ajax({
            type: "GET",
            url: "././module/RPT_CONTAINER_CONFIRM/data.php",
            dataType: "json",
            data: {
                load: "GetBookingLine",
                doc_num: doc_num,
                co_num: co_num,
                cust_po: cust_po,
                cust_name: cust_name,
                city: city,
                sts_po: sts_po,
                size: size,
                remain: remain ? remain : '',
                ready: ready ? ready : ''
            },
            success: function (data) {

                if (data.length == 0) {
                    alert("ไม่พบข้อมูล");
                    $("#btnAddContainerManage").attr("disabled", true);
                    $("#btnViewContainer").attr("disabled", true);
                    $("#doc_num_ref").val('');
                    $("#co_num_ref").val('');
                    $("#co_line").val('');
                    $("#end_cust").val('');
                    $("#end_city").val('');
                    $("#container_no").val('');
                    $("#bundle").val("");
                    table.clear().draw();
                    return false;
                }

                // reset column visible
                for (let i = 16; i <= 30; i++) {
                    table.column(i).visible(false);
                }

                table.clear();

                table.rows.add(data).draw();
              
                $("#btnAddContainerManage").attr("disabled", true);
                $("#btnViewContainer").attr("disabled", true);
                $("#doc_num_ref").val('');
                $("#co_num_ref").val('');
                $("#co_line").val('');
                $("#end_cust").val('');
                $("#end_city").val('');
                $("#container_no").val('');
                $("#bundle").val("");

                maxWeight = data[0].cont_weight *1000;
                
                $.ajax({
                    type: "GET",
                    url: "././module/RPT_CONTAINER_CONFIRM/data.php",
                    dataType: "json",
                    data: {
                        load: "GetTotalWeight",
                        doc_num: $("#doc_num_manage").val()
                    },
                    success: function (data) {
                        // find max cont_no
                        let max_cont_no = 0;
                        data.forEach(function (item) {
                            if (item.cont_no > max_cont_no) {
                                max_cont_no = item.cont_no;
                            }
                        });
                        let con_no = 16;
                        // loop check every row at field name 1 - 30 if not null + 1
                        // visible column over con_no
                        for (let i = 16; i <= max_cont_no + 16; i++) {
                            table.column(i).visible(true);
                        }

                   

                        isVisible = con_no + max_cont_no + 1;
                        // show total weight on table header id th1 
                        // 16 - 45


                        if (data.length > 0) {
                            data.forEach(function (item) {
                            var columnIndex = item.cont_no + 15; // เพิ่ม 15 เพื่อให้ 1 กลายเป็น 16
                            table.column(columnIndex).header().innerHTML =
                                '<span>' + item.cont_no + '</span><br>' +
                                '<span style="color: ' + (item.total_weight > maxWeight ? 'red' : 'black') + ';">' + addCommas(item.total_weight) + '</span><br>' +
                                '<span style="color: ' + (item.area > 420 ? 'red' : 'black') + ';">' + item.area + '</span><br>' +
                                '<span>' + item.total_bundle + '</span>';
                        });
                        }  else {
                            // reset name 1-30
                            for (let i = 1; i <= 30; i++) {
                                table.column(i + 15).header().innerHTML = '<span>' + i + '</span>';
                            }
                        }
                    }
                });

            },
            error: function (xhr, status, error) {
                alert('Error');
            }
        });
    });


    function SaveContainer(element, rowIndex, type, container_no) {
        console.log(rowIndex);
        
        let $input = $(element);
        let newValue = $input.val();
        let fieldName = $input.data('field');


        // ดึงข้อมูล row จาก DataTable
        let row = table.row(rowIndex).data();
        console.log(type);
        

        if (type == 'bundle') {
            if (row[container_no] !== null) {
                $.ajax({
                    type: "POST",
                    url: "././module/RPT_CONTAINER_CONFIRM/data.php",
                    dataType: "json",
                    data: {
                        load: "UpdateContainerLine",
                        doc_num: row.doc_num,
                        co_num: row.co_num,
                        item: row.item,
                        container_no: container_no,
                        bundle: newValue
                    },
                    success: function (data) {
                        console.log(data);
                    },
                    error: function (xhr, status, error) {
                        alert('Error');
                    }
                });
            } else {
                $.ajax({
                    type: "POST",
                    url: "././module/RPT_CONTAINER_CONFIRM/data.php",
                    dataType: "json",
                    data: {
                        load: "CreateContainerLine",
                        doc_num: row.doc_num,
                        co_num: row.co_num,
                        item: row.item,
                        end_cust: row.name,
                        city: row.city,
                        container_no: container_no,
                        bundle: newValue
                    },
                    success: function (data) {
                        // update data on row
                        table.row(rowIndex).data()[container_no] = newValue;
                    },
                    error: function (xhr, status, error) {
                        alert('Error');
                    }
                });
            }
        } else {
            $.ajax({
                type: "POST",
                url: "././module/RPT_CONTAINER_CONFIRM/data.php",
                dataType: "json",
                data: {
                    load: "UpdateContainerPcs",
                    doc_num: row.doc_num,
                    co_num: row.co_num,
                    item: row.item,
                    container_no: container_no,
                    bundle: newValue
                },
                success: function (data) {
                    console.log(data);
                },
                error: function (xhr, status, error) {
                    alert('Error');
                }
            });
        }

        setTimeout(function () {
            $.ajax({
                type: "GET",
                url: "././module/RPT_CONTAINER_CONFIRM/data.php",
                dataType: "json",
                data: {
                    load: "GetTotalWeight",
                    doc_num: $("#doc_num_manage").val()
                },
                success: function (data) {

                    data.forEach(function (item) {
                            var columnIndex = item.cont_no + 15; // เพิ่ม 15 เพื่อให้ 1 กลายเป็น 16
                            table.column(columnIndex).header().innerHTML =
                                '<span>' + item.cont_no + '</span><br>' +
                                '<span style="color: ' + (item.total_weight > maxWeight ? 'red' : 'black') + ';">' + addCommas(item.total_weight) + '</span><br>' +
                                '<span style="color: ' + (item.area > 440 ? 'red' : 'black') + ';">' + item.area + '</span><br>' +
                                '<span>' + item.total_bundle + '</span>';
                        });
                }
            });
        }, 1000);

        // อัพเดตข้อมูลใน DataTable
    }

    $('#btnViewContainer').click(function () {
        // add data to table #tblReportContainerManage
        let doc_num = $("#doc_num_ref").val();
        let co_num = $("#co_num_ref").val();
        let co_line = $("#co_line").val();


        $.ajax({
            type: "POST",
            url: "././module/RPT_CONTAINER_CONFIRM/data.php",
            dataType: "json",
            data: {
                load: "GetContainerLine",
                doc_num: doc_num,
                co_num: co_num,
                co_line: co_line
            },
            success: function (data) {


                $("#btnAddContainerManage").attr("disabled", false);
                $("#btnUpdateBooking").attr("disabled", true);

                // destroy table
                $('#tblReportContainerLine').DataTable().destroy();


                let table = $('#tblReportContainerLine').DataTable({
                    "columnDefs": [
                        { "targets": '_all', "className": 'text-center' }

                    ],
                    columns: [
                        // edit  last column
                        { data: "doc_no" },
                        { data: "co_num" },
                        { data: "co_line" },
                        { data: "end_cust" },
                        { data: "city" },
                        { data: "cont_no" },
                        {
                            data: "bundle",
                            render: function (data) {
                                var ret = `<input type='text' class='form-control' value='${data}'>`;
                                return ret;
                            }
                        },
                    ]
                });
                table.clear().rows.add(data).draw();

                // open modal
                $('#ModalContainer').modal('show');
                // clear form
                $("#co_num_booking").val("").trigger("change");
                $("#container_40").val("");
                $("#container_45").val("");
                $("#booking_number40").val("");
                $("#booking_number45").val("");
                $("#booking_date").val("");
                $("#old_co_num").val("");

            }
        });
    });


    $("#booking_date").datepicker({
        dateFormat: "yy-mm-dd",
        showAnim: "slideDown"
    });

    // create table print custom
    

   






</script>
<style>
      td.table-cell-edit{
    background-color: #E0E0E0;
}
</style>


<div class="row" style="border-bottom:solid 1px #e8e8e8;">  
    <div style="margin-top: 10px; margin-bottom: 20px;">
      <h1 class="my-header">Stock Order Planning</h1>
     </div>
</div>

<div class="row">
    <div class="col-lg-3 col-search">
        <div class="input-group">
            <div class="input-group-addon">Item</div>
            <input type="text" class="form-control txt-filter" id="BY_Item">
        </div>
    </div>

    <div class="col-lg-1 col-md-2 col-sm-1 col-xs-6  col-search">
        <button id="BtnSearchItem" class="btn btn-info"><i class="fa fa-search"></i>Search</button>
    </div>
</div>

    <div class="row" id="divReportByitem">
        <table class="table table-condensed table-bordered table-striped" id="tblReportByitem">
            <thead>
                <tr>
                    <th>NO</th>
                    <th>item</th>
                    <th>co_num</th>
                    <th>co_line</th>
                    <th>due_date</th>
                    <th>projected_date</th>
                    <th>STS_PO</th>
                    <th>qty_ordered</th>
                    <th>qty_shipped</th>
                    <th>qty_ready</th>
                    <th>qty_need</th>
                    <th>avai_FC</th>
                    <th>FC_cumulative</th>
                    <th>avai_WC</th>
                    <th>avai_WSHR_PCS</th>
                    <th>avai_RHR_PCS</th>
                    <th>avai_WSHR_KG</th>
                    <th>avai_RHR_KG</th>
                    <th>avai_RC</th>
                    <th style="background-color: #E0E0E0;">WSHR_KGperPCS</th>
                    <th style="background-color: #E0E0E0;">RHR_KGperPCS</th>

                </tr>
        </table>
    </div>

<script type="text/javascript">

    $("#BtnSearchItem").click(function () {
            ReportAllSearch();
        });


    function ReportAllSearch() {
    var OldHtml = $("#BtnSearchItem").html();
    var Item = $("#BY_Item").val();

    if (Item == "") {
        $.alert("กรุณากรอกข้อมูล");
    } else {
        $.ajax({
            type: 'POST',
            url: "././module/RPT_Stock_Order_Planning/data.php",
            dataType: 'json',
            beforeSend: function () {
                $("#BtnSearchItem").html("<i class='fa fa-spinner fa-spin'>");
            },
            data: {
                "load": "BY_Item",
                "Item": Item,
            },
            success: function (data) {
                console.log(data)

                $("#tblReportByitem").DataTable().clear();
                    var RowFooterBuild = "";
                    var ColBuild = "";
                    var ColCount = 21;
                    var i = 0;
                    RowFooterBuild = "<tfoot><tr>!!ColBuild!!</tr></tfoot>";
                    for (i = 1; i <= ColCount; i++) {
                        ColBuild += "<td></td>";
                    }
                    $("#tblReportByitem").append(RowFooterBuild.replace("!!ColBuild!!", ColBuild));

                $("#tblReportByitem").dataTable().fnDestroy();
                var table = $('#tblReportByitem').DataTable({
                    scrollY: "400px",
                    "scrollX": true,
                    scrollCollapse: true,
                    "aaData": data,
                    "paging": false,
//                        fixedColumns: {
//                            leftColumns: 1,
//                        },
                    "searching": false,
                    "bInfo": false,

                    "columns": [
                        {
                        "data": "STS_PO",
                        "className": "text-center",
                        render: function (data, type, row, meta) {
                            return meta.row + meta.settings._iDisplayStart + 1;
                        }
                        },
                        {"data": "item",
                            "className": "text-center",
                        },
                        {"data": "co_num",
                            "className": "text-center",
                        },
                        {"data": "co_line",
                            "className": "text-center",
                        },
                        {"data": "Due_Date",
                            "className": "text-center",
                        },
                        {"data": "projected_date.date",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data){
                                var ret = moment(data).format('YYYY-MM-DD')
                                return ret;
                            } else {
                                return "";
                            }
                        }
                        },
                        {"data": "STS_PO",
                            "className": "text-center",
                        },
                        {"data": "qty_ordered",
                            "className": "text-left",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "qty_shipped",
                            "className": "text-left",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "qty_ready",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "qty_need",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "avai_FC",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "FC_cumulative",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "avai_WC",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "avai_WSHR_PCS",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "avai_RHR_PCS",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "avai_WSHR_KG",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "avai_RHR_KG",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "avai_RC",
                            "className": "text-center",
                            "render": function (data, type, row, meta) {
                            if (data < 0){
                                var ret = `<span style="color: red;">${new Intl.NumberFormat("en-US").format(Math.floor(data))}</span>`
                            }
                            else{
                                var ret = new Intl.NumberFormat("en-US").format(Math.floor(data))
                            }
                            return ret;
                        }
                        },
                        {"data": "avai_WSHR_KGperPCS",
                            "className": "table-cell-edit",
                            "render": function (data, type, row, meta) {
                            var ret = (data)
                            return ret;
                        }
                        },
                        {"data": "avai_RHR_KGperPCS",
                            "className": "table-cell-edit",
                            "render": function (data, type, row, meta) {
                            var ret = (data)
                            return ret;
                        }
                        },
                    ],
                    'dom': "<'row'<'col-md-5'B><'col-md-7 text-right col-flt-page'lf>>" +
                            "<'row'<'col-md-12'tr>>" +
                            "<'row'<'col-md-5 text-left'i><'col-sm-7 text-right'p>>",
                    buttons: [
                        {
                            extend: 'print',
                            text: "<i class='fa fa-print'></i>&nbsp;Print",
                            title: ''
                        },
                        {
                            extend: 'excel',
                            text: "<i class='fa fa-file-excel'></i>&nbsp;Excel&nbsp;",
                            title: `ReportByitem`,
                            customize: function (xlsx) {
                                var sheet = xlsx.xl.worksheets['sheet1.xml'];
                                var numrows = 2;
                            }
                        },
                    ],
                    "footerCallback": function (row, data, start, end, display) {
                            var api = this.api(),
                                    data;

                            // converting to interger to find total
                            var intVal = function (i) {
                                return typeof i === 'string' ?
                                        i.replace(/[\$,]/g, '') * 1 :
                                        typeof i === 'number' ?
                                        i : 0;
                            };

                            // computing column Total of the complete result

                            
                            var qty_ordered = api
                                    .column(7)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(a) + intVal(b);
                                    }, 0);

                            var qty_shipped = api
                                    .column(8)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(a) + intVal(b);
                                    }, 0);

                            var qty_ready = api
                                    .column(9)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(a) + intVal(b);
                                    }, 0);

                            var qty_need = api
                                    .column(10)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(a) + intVal(b);
                                    }, 0);

                            var avai_FC = api
                                    .column(11)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(b) > intVal(a) ? intVal(b) : intVal(a);
                                    }, 0);

                            var avai_WC = api
                                    .column(13)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(b) > intVal(a) ? intVal(b) : intVal(a);
                                    }, 0);

                            var avai_WSHR_PCS = api
                                    .column(14)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(b) > intVal(a) ? intVal(b) : intVal(a);
                                    }, 0);

                            var avai_RHR_PCS = api
                                    .column(15)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(b) > intVal(a) ? intVal(b) : intVal(a);
                                    }, 0);

                            var avai_WSHR_KG = api
                                    .column(16)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(b) > intVal(a) ? intVal(b) : intVal(a);
                                    }, 0);

                            var avai_RHR_KG = api
                                    .column(17)
                                    .data()
                                    .reduce(function (a, b) {
                                        return intVal(b) > intVal(a) ? intVal(b) : intVal(a);
                                    }, 0);
                              
                            var avai_WSHR_KGperPCS = api
                                .column(19)
                                .data()
                                .reduce(function (a, b) {
                                    return intVal(b) > intVal(a) ? intVal(b) : intVal(a);
                                }, 0);

                            var avai_RHR_KGperPCS = api
                                .column(20)
                                .data()
                                .reduce(function (a, b) {
                                    return intVal(b) > intVal(a) ? intVal(b) : intVal(a);
                                }, 0);

                            $(api.column(7).footer()).html(addCommas(qty_ordered.toFixed(2)));
                            $(api.column(8).footer()).html(addCommas(qty_shipped.toFixed(2)));
                            $(api.column(9).footer()).html(addCommas(qty_ready.toFixed(2)));
                            $(api.column(10).footer()).html(addCommas(qty_need.toFixed(2)));
                            $(api.column(11).footer()).html(addCommas(avai_FC.toFixed(2)));
                            $(api.column(12).footer()).html(addCommas((avai_FC-qty_need).toFixed(2)));
                            $(api.column(13).footer()).html(addCommas(((avai_FC+avai_WC)-qty_need).toFixed(2)));
                            $(api.column(14).footer()).html(addCommas(((avai_FC+avai_WC)-qty_need+avai_WSHR_PCS).toFixed(2)));
                            $(api.column(15).footer()).html(addCommas(((avai_FC+avai_WC)-qty_need+avai_WSHR_PCS+avai_RHR_PCS).toFixed(2)));
                            $(api.column(16).footer()).html(addCommas((((avai_FC+avai_WC)-qty_need+avai_WSHR_PCS)*avai_WSHR_KGperPCS).toFixed(2)));
                            $(api.column(17).footer()).html(addCommas((((avai_FC+avai_WC)-qty_need+avai_WSHR_PCS+avai_RHR_PCS)*avai_RHR_KGperPCS).toFixed(2)));

                        },
                });
                $('#tblReportByitem').loading("stop");
                $("#BtnSearchItem").html("<i class='fa fa-search'></i>Search");
            },
            error: function (e) {
                console.log("There was an error with your request...");
                console.log("error: " + JSON.stringify(e));
            }
        });
    }
}
</script>
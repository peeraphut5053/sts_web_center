<style>
    /* ซ่อน Checkbox ดั้งเดิม */
    .custom-checkbox input[type="checkbox"] {
        display: none;
    }

    /* ตำแหน่งและขนาดของ Checkbox */
    .custom-checkbox {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        font-size: 20px;
        margin: 3px;
    }

    /* สไตล์สำหรับ Checkmark */
    .custom-checkbox .checkmark {
        width: 20px;
        height: 20px;
        background-color: #ccc;
        border-radius: 4px;
        display: inline-block;
        margin-right: 10px;
        position: relative;
        transition: background-color 0.3s;
    }

    /* สไตล์สำหรับ Checkbox เมื่อถูกเลือก */
    .custom-checkbox input[type="checkbox"]:checked+.checkmark {
        background-color: #4CAF50;
    }

    /* สไตล์สำหรับเครื่องหมายถูก */
    .custom-checkbox .checkmark::after {
        content: "";
        position: absolute;
        display: none;
    }

    /* แสดงเครื่องหมายถูกเมื่อ Checkbox ถูกเลือก */
    .custom-checkbox input[type="checkbox"]:checked+.checkmark::after {
        display: block;
    }

    /* รูปแบบของเครื่องหมายถูก */
    .custom-checkbox .checkmark::after {
        left: 8px;
        top: 3px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 3px 3px 0;
        transform: rotate(45deg);
    }

    .mycontainer {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 90%;
        margin-left: auto;
        margin-right: auto;
        border-width: 4px;
        border-bottom-color: #60a5fa;
        border-top-color: white;
        border-left-color: white;
        border-right-color: white;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        padding: 6rem;
        margin-top: 2.5rem;
    }

    .mybox {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        flex-grow: 1;
        gap: 1.5rem;
        margin-bottom: 1.25rem;
    }

    .imagBox {
        border: 1px solid #d1d5db;
        /* เทียบเท่ากับ border-gray-300 */
        padding: 0.5rem 1.25rem;
        /* px-5 = 1.25rem, py-2 = 0.5rem */
        margin-right: 1rem;
        /* mr-4 = 1rem */
    }
</style>
<div class="">
    <div class="col-xs-12">
        <div class="page-header">
            <h1 class="text-header text-left">QC</h1>
        </div>
    </div>
</div>
<div class="mycontainer mb-12">
    <div class="row col-xs-12">
        <div class="mybox">
            <div class="input-group basis-3/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">Doc No</div>
                <select style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="doc_no_return_qc">
                    <option value=""></option>
                </select>
            </div>
            <div class="input-group basis-3/6">
                <div class="flex gap-6">
                    <button type="button" class="btn btn-primary btn-lg" id="btnSearchReturnQc">Search</button>
                    <button type="button" class="btn btn-warning btn-lg" id="btnResetReturnQc">Reset Form</button>
                </div>
            </div>
            <div class="input-group basis-2/6">
            </div>
        </div>
        <hr />
        <div class="mybox">
            <div class="input-group basis-3/6">
                <div style="color: red; font-weight: bold; font-size: 16px;" class="input-group-addon">Sale *</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="sale_qc" readonly>
            </div>
            <div class="input-group basis-3/6">
                <div style="font-weight: bold; font-size: 16px;" class="input-group-addon">หมายเหตุ</div>
                <input type="text" style="font-weight: bold; font-size: 16px;" class="form-control txt-filter"
                    id="remark_qc" readonly>
            </div>
        </div>
        <div class="mybox">
            <div class="input-group basis-3/6">
                <div style="display: flex; align-items: center;" id="file_upload">
                    <div style="font-weight: bold; font-size: 16px;" class="imagBox">รูปภาพ</div>
                    <div class="imagBox">
                        <input type="file" id="file-input" multiple accept="image/jpeg, image/png, image/jpg">
                    </div>
                    <button type="button" class="btn btn-info" id="btnUploadImageQc">อัปโหลดรูปภาพ</button>
                    <button style="margin-left: 10px;" type="button" class="btn btn-success"
                        id="btnOpenImageQc">ดูรูปภาพ</button>
                </div>
            </div>
        </div>
        <hr />
        <div class="flex justify-between">
            <div class="flex gap-4">
                <div id="status_repair" class="input-group element2 ">
                    <button type="button" class="btn btn-warning btn-lg" id="return_qc" onclick="approve_qc()">ลงชื่อ
                        QC</button>
                </div>
            </div>
        </div>
        <input type="text" style="font-weight: bold; font-size: 16px;" class="hidden" id="old_co_num">
    </div>
</div>
<div class="row">
    <table width="100%" class="table table-condensed table-bordered table-striped" id="tbItemReturnQc">
        <thead>
            <tr>
                <th class="bg-gray">do num</th>
                <th class="bg-gray">co num</th>
                <th class="bg-gray">ลูกค้า</th>
                <th class="bg-gray">Item</th>
                <th class="bg-gray">Desc</th>
                <th class="bg-gray">จำนวน</th>
                <th class="bg-gray">ปัญหา</th>
                <th class="bg-gray">สาเหตุ</th>
                <th class="bg-gray">Status</th>
                <th class="bg-gray">หมายเหตุ</th>
            </tr>
        </thead>
        <!--        <tbody id="tblReportList">
                      <tr><td align="center" colspan="12">.... No item search ....</td></tr>
     </tbody>-->
    </table>
</div>
<!-- Modal -->
<div class="modal fade bd-example-modal-lg" id="ModalReturnQcImg" role="dialog" aria-labelledby="myLargeModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title text-center" id="exampleModalLabel">รูปภาพทั้งหมด</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <table width="100%" class="table table-condensed table-bordered table-striped"
                        id="tbItemReturnQcImg">
                        <thead>
                            <tr>
                                <th class="bg-gray">do num</th>
                                <th class="bg-gray">รูปภาพ</th>
                            </tr>
                        </thead>
                        <!--        <tbody id="tblReportList">
                      <tr><td align="center" colspan="12">.... No item search ....</td></tr>
     </tbody>-->
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bwip-js/4.5.1/bwip-js-min.js"
    integrity="sha512-nyvUcUIS1L4Z+cowD7We9KKcq/ivAJhTlhZTjBfBFGYV1I+RAqSrHS/WEcWDp1CVKRw1j5SxYCPCSYOQxuIE1w=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
    var username_session = GetUserProp("login_username");

    getDocNumList();

    var data_withdraw = [];


    function openImage(src) {
        var win = window.open(src, '_blank');
        win.focus();
    }

    function getDocNumList() {
        $.ajax({
            type: "GET",
            url: "././module/STS_RETURN_ITEM/data.php",
            dataType: "json",
            data: {
                load: "GetDocNoReturn"
            },
            success: function (data) {
                let doc = [{ id: '', text: '' }].concat(data.map((item) => ({
                    id: item.doc_no,
                    text: item.doc_no
                })));

                // clear select2
                $("#doc_no_return_qc").empty();

                $("#doc_no_return_qc").select2({
                    placeholder: 'Doc No',
                    allowClear: true,
                    width: '100%',
                    data: doc,
                    language: {
                        noResults: function () {
                            return "ไม่พบข้อมูล";
                        }
                    }
                });
            }
        });
    }
    var cause = [];
    var issue = [];

    $.ajax({
        type: "GET",
        url: "././module/STS_RETURN_ITEM/data.php",
        dataType: "json",
        data: { load: "GetReasonCause" },
        success: function (result) {

            causeOptions = [{ id: '', text: '' }].concat(result.map((item) => ({
                id: item.id,
                text: item.cause
            })));
            cause = causeOptions;
        }
    });

    $.ajax({
        type: "GET",
        url: "././module/STS_RETURN_ITEM/data.php",
        dataType: "json",
        data: { load: "GetIssueReturn" },
        success: function (result) {
            issue = result;
        }
    });

    $('#btnOpenImageQc').click(function () {
        var tableImg = $('#tbItemReturnQcImg').DataTable({
            "columnDefs": [
                { "targets": '_all', "className": 'text-center' },
                { "targets": 0, "width": "200" },
                { "targets": 1, "width": "400" },

            ],
            columns: [
                { "data": "doc_no" },
                {
                    "data": "path",
                    "render": function (data, type, row) {
                        return '<div style="display: flex; align-items: center; justify-content: center;"><img src="module/STS_RETURN_ITEM/upload/' + data + '?v=' + Date.now() + '" style="width: 50px; height: 50px; " onclick="openImage(this.src)"></div>';
                    }
                },
            ],
            paging: false,
            searching: false,
            select: false,
            destroy: true,
            dom:
                "<'row'<'col-md-5'B><'col-md-7 text-right col-flt-page'lf>>" +
                "<'row'<'col-md-12'tr>>" +
                "<'row'<'col-md-5 text-left'i><'col-sm-7 text-right'p>>",
            buttons: [

            ],
        });
        $.ajax({
            type: "GET",
            url: "././module/STS_RETURN_ITEM/data.php",
            dataType: "json",
            data: {
                load: "GetReturnPicByDocNo",
                doc_no: $("#doc_no_return_qc").val()
            },
            success: function (data) {
                tableImg.clear();
                tableImg.rows.add(data).draw();
            },
            error: function (xhr, status, error) {
                swal("เกิดข้อผิดพลาด กรุณาลองใหม่", "", "warning");
            }
        });
        $('#ModalReturnQcImg').modal('show');
    })


    var tableReceive = $('#tbItemReturnQc').DataTable({
        "columnDefs": [
            { "targets": '_all', "className": 'text-center' },
            { "targets": 0, "width": "60" },
            { "targets": 1, "width": "60" },
            { "targets": 2, "width": "120" },
            { "targets": 3, "width": "160" },
            { "targets": 4, "width": "160" },
            { "targets": 5, "width": "60" },
            { "targets": 6, "width": "120" },
            { "targets": 7, "width": "120" },
            { "targets": 8, "width": "80" },
            { "targets": 9, "width": "100" },

        ],
        columns: [
            { "data": "do_num" },
            { "data": "co_num" },
            { "data": "customer" },
            { "data": "item" },
            { "data": "description" },
            { "data": "qty" },
            { "data": "issue",
                render: function (data, type, row, meta) {
                    return issue.find(issue => issue.id === data)?.issue || '';
                    
                }
             },
            {
                data: "cause",
                render: function (data, type, row, meta) {
                    var selected = data || '';
                    return '<select class="form-control txt-filter reason_select cause-select" data-row="' + meta.row + '" data-selected="' + selected + '" style="width: 100%;"></select>';
                }
            },
            { "data": "stat",
                render: function (data, type, row, meta) {
                    var status = data || '';
                    return '<select class="form-control txt-filter status_select" data-row="' + meta.row + '" data-selected="' + status + '" style="width: 100%;"></select>';
            }},
            { "data": "remark",
                render: function (data, type, row, meta) {
                    return '<input type="text" class="form-control txt-filter remark-input" data-row="' + meta.row + '" value="' + (data || '') + '" onchange="SaveRemarkQc(this, ' + meta.row + ')"/>';
                }
            },
        ],
        drawCallback: function () {
            $('.cause-select').each(function () {
                var $select = $(this);
                var selectedValue = $select.data('selected');

                if (!$select.hasClass('select2-hidden-accessible')) {
                    $select.select2({
                        placeholder: 'สาเหตุ',
                        allowClear: true,
                        width: '100%',
                        data: cause,
                        language: {
                            noResults: function () {
                                return "ไม่พบข้อมูล";
                            }
                        }
                    });

                    // Set selected value if exists
                    if (selectedValue) {
                        $select.val(selectedValue).trigger('change');
                    }

                    $select.on('change', function () {
                        var value = $(this).val();
                        var rowIndex = $(this).data('row');
                        var rowData = tableReceive.row(rowIndex).data();

                        // Update DataTable
                        $.ajax({
                            type: "POST",
                            url: "././module/STS_RETURN_ITEM/data.php",
                            dataType: "json",
                            data: {
                                load: "UpdateCause",
                                doc_no: rowData.doc_no,
                                do_num: rowData.do_num,
                                co_num: rowData.co_num,
                                item: rowData.item,
                                cause: value
                            },
                            success: function (data) {
                            },
                            error: function (xhr, status, error) {
                                alert('Error');
                            }
                        })
                    });
                }
            });

            $('.status_select').each(function () {
                var $select = $(this);
                var selectedValue = $select.data('selected');

                var status = [
                    { id: '', text: '' },
                    { id: 'Reject', text: 'Reject' },
                    { id: 'NC Accept', text: 'NC Accept' },
                    { id: 'Fix', text: 'Fix' }
                ];

                if (!$select.hasClass('select2-hidden-accessible')) {
                    $select.select2({
                        placeholder: 'สถานะ',
                        allowClear: true,
                        width: '100%',
                        data: status,
                        language: {
                            noResults: function () {
                                return "ไม่พบข้อมูล";
                            }
                        }
                    });

                    // Set selected value if exists
                    if (selectedValue) {
                        $select.val(selectedValue).trigger('change');
                    }

                    $select.on('change', function () {
                        var value = $(this).val();
                        var rowIndex = $(this).data('row');
                        var rowData = tableReceive.row(rowIndex).data();

                        // Update DataTable
                        $.ajax({
                            type: "POST",
                            url: "././module/STS_RETURN_ITEM/data.php",
                            dataType: "json",
                            data: {
                                load: "UpdateStatus",
                                doc_no: rowData.doc_no,
                                do_num: rowData.do_num,
                                co_num: rowData.co_num,
                                item: rowData.item,
                                status: value
                            },
                            success: function (data) {
                            },
                            error: function (xhr, status, error) {
                                alert('Error');
                            }
                        });
                    });
                }
            });
        },
        paging: false,
        searching: false,
        select: false,
        dom:
            "<'row'<'col-md-5'B><'col-md-7 text-right col-flt-page'lf>>" +
            "<'row'<'col-md-12'tr>>" +
            "<'row'<'col-md-5 text-left'i><'col-sm-7 text-right'p>>",
        buttons: [

        ],
    });

    function SaveRemarkQc(input, row) {
        var value = $(input).val();
        var rowData = tableReceive.row(row).data();
        console.log(rowData);
        

        // Update DataTable
        $.ajax({
            type: "POST",
            url: "././module/STS_RETURN_ITEM/data.php",
            dataType: "json",
            data: {
                load: "UpdateRemarkQc",
                doc_no: rowData.doc_no,
                do_num: rowData.do_num,
                co_num: rowData.co_num,
                item: rowData.item,
                remark: value
            },
            success: function (data) {
            },
            error: function (xhr, status, error) {
                alert('Error');
            }
        });
    }


    $("#btnResetReturnQc").click(function () {
        tableReceive.clear().draw();
        $("#doc_no_return_qc").val('').trigger("change");
        $("#sale_qc").val('');
        $("#remark_qc").val('');
        // reset btn disabled and text


        $("#return_qc").text("ลงชื่อ QC");
        $("#return_qc").attr("disabled", false);
    })

    $("#btnSearchReturnQc").click(function () {
        var doc_no = $("#doc_no_return_qc").val();

        if (doc_no == '') {
            swal("กรุณาเลือกเลขที่ใบเบิกที่ต้องการค้นหา!", "", "warning");
            return false;
        }

        $.ajax({
            type: "GET",
            url: "././module/STS_RETURN_ITEM/data.php",
            dataType: "json",
            data: {
                load: "GetItemReturnByDocNo",
                doc_no: doc_no
            },
            success: function (data) {

                tableReceive.clear();
                tableReceive.rows.add(data).draw();
                $("#sale_qc").val(data[0].sales);
                $("#remark_qc").val(data[0].remark_h);

                if (data[0].qc !== null) {
                    $("#return_qc").text("QC ตรวจแล้ว");
                    $("#return_qc").attr("disabled", true);
                } else {
                    $("#return_qc").text("ลงชื่อ QC");
                    $("#return_qc").attr("disabled", false);
                }

                data_withdraw = data;


            },
            error: function (xhr, status, error) {
                swal("เกิดข้อผิดพลาด กรุณาลองใหม่", "", "warning");
            }
        });
    });

    async function resizeImage(file, maxWidth, maxHeight) {
        // Create Image object
        const img = new Image();
        const reader = new FileReader();

        // Return a promise that resolves when the image is loaded and processed
        return new Promise((resolve) => {
            reader.onload = function (e) {
                img.src = e.target.result;

                img.onload = function () {
                    // Create canvas
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Calculate proportions
                    let width = img.width;
                    let height = img.height;
                    let ratio = 1;

                    if (width > height) {
                        if (width > maxWidth) {
                            ratio = maxWidth / width;
                        }
                    } else {
                        if (height > maxHeight) {
                            ratio = maxHeight / height;
                        }
                    }

                    width = width * ratio;
                    height = height * ratio;

                    // Set canvas size
                    canvas.width = width;
                    canvas.height = height;

                    // Draw resized image on canvas
                    ctx.drawImage(img, 0, 0, width, height);

                    // Convert to blob and then to file
                    canvas.toBlob((blob) => {
                        const resizedImage = new File([blob], file.name, { type: file.type });
                        resolve(resizedImage);
                    }, file.type);
                };
            };

            reader.readAsDataURL(file);
        });
    }

    $('#btnUploadImageQc').click(function () {
        const fileInputs = document.getElementById('file-input').files;
        const doc_no = $("#doc_no_return_qc").val();

        if (doc_no == '') {
            swal("กรุณาเลือกเลขที่ใบเบิกที่ต้องการอัพโหลดรูปภาพ!", "", "warning");
            return false;
        }

        if (!fileInputs || fileInputs.length === 0) {
            alert("กรุณาเลือกไฟล์รูปภาพ");
            return false;
        }

        // สร้าง FormData เพื่อส่งไฟล์
        const formData = new FormData();
        formData.append('load', 'CreateReturnPic');
        formData.append('doc_no', doc_no);

        // ส่งไฟล์ที่เลือกทั้งหมด
        for (let i = 0; i < fileInputs.length; i++) {
            const file = fileInputs[i];
            if (file.type !== 'image/jpg' && file.type !== 'image/jpeg' && file.type !== 'image/png') {
                alert("กรุณาเลือกไฟล์รูปภาพ");
                return false;
            }
            formData.append('file[]', file);
        }

        $.ajax({
            type: "POST",
            url: "././module/STS_RETURN_ITEM/upload.php",
            dataType: "json",
            data: formData,
            processData: false, // สำคัญ: ห้าม jQuery ประมวลผลข้อมูล
            contentType: false,
            success: function (data) {
                swal("อัปโหลดรูปภาพสําเร็จ!", "", "success");
            },
            error: function (xhr, status, error) {
                alert('Error');
            }
        });
    });


    function UpdateDataTable(val, doc_no, item, line_id, row) {

        $.ajax({
            type: "POST",
            url: "././module/APP_STORE_WITHDRAW/data.php",
            dataType: "json",
            data: {
                load: "UpdateQty_rcvd",
                doc_no: doc_no,
                item: item,
                line_id: line_id,
                val: val
            },
            success: function (data) {
                tableReceive.cell(row, 4).data(val).draw();
            },
            error: function (xhr, status, error) {
                alert('Error');
            }
        });
    }

    function UpdateDataTableReturn(val, doc_no, line_id, wc_dest) {
        $.ajax({
            type: "POST",
            url: "././module/APP_STORE_WITHDRAW/data.php",
            dataType: "json",
            data: {
                load: "UpdateQty_return",
                doc_no: doc_no,
                item: item,
                line_id: line_id,
                val: val
            },
            success: function (data) {
                console.log('success');

            },
            error: function (xhr, status, error) {
                alert('Error');
            }
        });
    }

    function approve_qc() {

        if ($("#doc_no_return_qc").val() == '') {
            alert("กรุณาเลือก Doc No");
            return false;
        }

        $.confirm({
            title: 'ตรวจสอบโดย',
            theme: 'modern',
            content: '<input placeholder="ตัดสต๊อก" type="text" id="i_return_qc" class="form-control my-2" value="' + username_session + '" autofocus>',
            buttons: {
                confirm: function () {
                    var stock = $("#i_return_qc").val();

                    $.ajax({
                        type: "POST",
                        url: "././module/STS_RETURN_ITEM/data.php",
                        dataType: "json",
                        data: {
                            load: "ApproveQc",
                            doc_no: $("#doc_no_return_qc").val(),
                            qc: username_session
                        },
                        success: function (data) {
                            alert("บันทึกข้อมูลสําเร็จ");
                            // edit text btn approve_qc
                            $("#return_qc").text("QC ตรวจแล้ว");
                            $("#return_qc").attr("disabled", true);
                        },
                        error: function (xhr, status, error) {
                            alert('Error');
                        }
                    });

                },
                cancel: function () {
                    window.close();
                }

            }
        });

    }

    function SaveMiscIssue() {

        const btn = $("#SaveMiscIssue");
        btn.prop('disabled', true);

        var doc_no = $("#doc_no_w_2").val();
        var item = $("#item_r_misc").val();
        var qty = $("#qty_r_misc").val();
        var loc = $("#loc_r_misc").val();
        var user = $("#user_r_misc").val();
        var reason = $("#reason_r_misc").val();
        var line_id = $("#line_id_item").val();
        var acct = $("#acct").val();
        var acct_unit1 = $("#acct_unit1").val();
        var um = $("#u_m_misc").val();

        if (doc_no == '' || item == '' || qty == '' || loc == '' || user == '' || reason == '' || line_id == '' || acct == '' || acct_unit1 == '' || um == '') {
            swal("กรุณากรอกข้อมูลให้ครบ", "", "warning");
            btn.prop('disabled', false);
            return false;
        }

        $.ajax({
            type: "POST",
            url: "././module/APP_STORE_WITHDRAW/data.php",
            dataType: "json",
            data: {
                load: "SaveMiscIssue",
                doc_no: doc_no,
                item: item,
                qty: qty,
                loc: loc,
                user: user,
                reason: reason,
                line_id: line_id,
                acct: acct,
                acct_unit1: acct_unit1,
                um: um
            },
            success: function (data) {
                tableReceive.clear();
                tableReceive.rows.add(data).draw();
                $("#ModalMiscIssue").modal("hide");
                var item = $("#item_r_misc").val('');
                var qty = $("#qty_r_misc").val('');
                var loc = $("#loc_r_misc").val('').trigger('change');
                var reason = $("#reason_r_misc").val('').trigger('change');
                var line_id = $("#line_id_item").val('');
                swal("ตัดสต๊อกสําเร็จ", "", "success");
                btn.prop('disabled', false);
            },
            error: function (xhr, status, error) {
                btn.prop('disabled', false);
                alert('Error');
            }
        });
    }

    function SaveMiscIssueByLot() {

        const btn = $("#SaveMiscIssueByLot");
        btn.attr("disabled", true);

        var doc_no = $("#doc_no_w_2").val();
        var item = $("#item_r_misc_lot").val();
        var lot = $("#lot_r_misc").val();
        var qty = $("#qty_r_misc_lot").val();
        var fromLoc = $("#from_loc_r_misc").val();
        var toLoc = $("#to_loc_r_misc").val();
        var user = $("#user_r_misc_lot").val();
        var line_id = $("#line_id_lot").val();

        if (doc_no == '' || item == '' || lot == '' || qty == '' || fromLoc == '' || toLoc == '' || user == '' || line_id == '') {
            swal("กรุณากรอกข้อมูลให้ครบ", "", "warning");
            btn.attr("disabled", false);
            return false;
        }

        $.ajax({
            type: "POST",
            url: "././module/APP_STORE_WITHDRAW/data.php",
            dataType: "json",
            data: {
                load: "SaveMiscIssueByLot",
                doc_no: doc_no,
                item: item,
                lot: lot,
                qty: qty,
                fromLoc: fromLoc,
                toLoc: toLoc,
                user: user,
                line_id: line_id
            },
            success: function (data) {
                tableReceive.clear();
                tableReceive.rows.add(data).draw();
                $("#ModalMiscIssueByLot").modal("hide");
                var item = $("#item_r_misc_lot").val('');
                var lot = $("#lot_r_misc").val('');
                var qty = $("#qty_r_misc_lot").val('');
                var fromLoc = $("#from_loc_r_misc").val('').trigger('change');
                // var toLoc = $("#to_loc_r_misc").val('').trigger('change');
                var line_id = $("#line_id_lot").val('');
                swal("ตัดสต๊อก Lot สําเร็จ!", "", "success");
                btn.attr("disabled", false);
            },
            error: function (xhr, status, error) {
                btn.attr("disabled", false);
                alert('Error');
            }
        });
    }

    /* $("#lot_r_misc").on('select2:select', function (e) {
                                    var lot = e.target.value;
                                     $.ajax({
                                    type: "GET",
                                    url: "././module/APP_STORE_WITHDRAW/data.php",
                                    dataType: "json",
                                    data: { load: "GetFromLoc", item: selectedRows[0].item, lot: lot },
                                    success: function (fromLoc) {
                                        var fromLocOptions = [{ id: '', text: '' }].concat(fromLoc.map((item) => ({
                                            id: item.loc,
                                            text: item.loc
                                        })))
                                        $("#from_loc_r_misc").empty();
                                        $("#from_loc_r_misc").select2({
                                            placeholder: 'กรุณาเลือก From Loc',
                                            allowClear: true,
                                            width: '100%',
                                            data: fromLocOptions,
                                            language: {
                                                noResults: function () {
                                                    return "ไม่พบข้อมูล";
                                                }
                                            }
                                        }).on('change', function (e) {
                                            var lot = $("#lot_r_misc").val();
                                            var val = e.target.value;
                                            var qty_on_hand = data.filter((item) => item.loc == val && item.lot == lot);
                                            if (qty_on_hand.length > 0) {
                                                $("#qty_r_misc_lot").val(qty_on_hand[0].qty_on_hand);
                                            } else {
                                                $("#qty_r_misc_lot").val('');
                                            }
                                        });
                                    }
                                }); */

</script>